<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Door Monitor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Outfit:wght@300;400;600;700&display=swap');
  :root {
    --bg: #0d1117; --card: #161b22; --border: #30363d;
    --green: #3fb950; --red: #f85149; --yellow: #d29922;
    --blue: #58a6ff; --text: #e6edf3; --muted: #8b949e;
  }
  body.light {
    --bg: #f4f6f8; --card: #ffffff; --border: #d0d7de;
    --green: #1a7f37; --red: #d1242f; --yellow: #9a6700;
    --blue: #0969da; --text: #1f2328; --muted: #656d76;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; min-height: 100vh; padding: 32px; transition: background 0.3s, color 0.3s; }
  .theme-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 14px; font-family: 'Outfit', sans-serif; transition: all 0.2s; margin-left: 12px; }
  @media (max-width: 768px) {
    body { padding: 16px; }
    header { flex-direction: column; align-items: flex-start; gap: 4px; }
    header h1 { font-size: 16px; }
    .cards { grid-template-columns: repeat(2, 1fr); }
    .count-row { grid-template-columns: 1fr 1fr; }
    table { font-size: 12px; }
    thead th, td { padding: 8px 10px; }
    .lqi-bar .bar { width: 40px; }
  }
  @media (max-width: 480px) {
    .cards { grid-template-columns: 1fr 1fr; }
    .count-row { grid-template-columns: 1fr; }
    .card .value { font-size: 24px; }
    thead th:nth-child(5), td:nth-child(5) { display: none; }
  }
  header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
  header h1 { font-size: 20px; font-weight: 600; }
  header span { font-family: 'Share Tech Mono', monospace; font-size: 13px; color: var(--muted); }
  .date-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; flex-wrap: wrap; }
  .date-bar label { font-size: 13px; color: var(--muted); }
  .date-bar input[type="date"] { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; font-family: 'Outfit', sans-serif; font-size: 14px; }
  .date-bar button { background: var(--blue); color: #0d1117; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; }
  .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
  .card .label { font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.8px; }
  .card .value { font-size: 32px; font-weight: 700; font-family: 'Share Tech Mono', monospace; }
  .card .sub { font-size: 13px; margin-top: 6px; color: var(--muted); }
  .card .badge { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 6px; }
  .badge.strong { background: #1a3a2a; color: var(--green); }
  .badge.medium { background: #3a2e10; color: var(--yellow); }
  .badge.weak   { background: #3a1a1a; color: var(--red); }
  .badge.good   { background: #1a3a2a; color: var(--green); }
  .badge.low    { background: #3a1a1a; color: var(--red); }
  .count-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  .count-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px 24px; display: flex; align-items: center; gap: 20px; }
  .count-icon { font-size: 32px; }
  .count-card .cnt-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  .count-card .cnt-value { font-size: 36px; font-weight: 700; font-family: 'Share Tech Mono', monospace; }
  .count-card .cnt-note  { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .cnt-open { color: var(--red); } .cnt-close { color: var(--green); }
  .history { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .history-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
  .history-header span { color: var(--muted); font-size: 12px; font-weight: 400; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { padding: 10px 20px; text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); font-weight: 400; }
  tbody tr { border-bottom: 1px solid #21262d; transition: background 0.15s; }
  tbody tr:hover { background: #1c2128; }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 12px 20px; }
  .state-pill { display: inline-block; padding: 3px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; font-family: 'Share Tech Mono', monospace; }
  .state-pill.open  { background: #3a1a1a; color: var(--red); }
  .state-pill.close { background: #1a3a2a; color: var(--green); }
  .event-pill { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 11px; background: #1c2a3a; color: var(--blue); }
  .event-pill.access { background: #1a2a1a; color: var(--green); }
  .lqi-bar { display: flex; align-items: center; gap: 8px; }
  .lqi-bar .bar { width: 60px; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; }
  .lqi-bar .fill { height: 100%; border-radius: 3px; }
  .fill.strong { background: var(--green); } .fill.medium { background: var(--yellow); } .fill.weak { background: var(--red); }
  .mono { font-family: 'Share Tech Mono', monospace; }
  .loading { text-align: center; padding: 40px; color: var(--muted); font-size: 14px; }
  .error-msg { color: var(--red); }
</style>
</head>
<body>

<header>
  <h1>ğŸšª IoT Door Monitor â€” device01</h1>
  <div style="display:flex;align-items:center;gap:12px;">
    <span id="now"></span>
    <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">â˜€ï¸ ãƒ©ã‚¤ãƒˆ</button>
  </div>
</header>

<div class="date-bar">
  <label>æ—¥ä»˜ / æ—¥æœŸ / Date</label>
  <input type="date" id="datePicker" readonly style="pointer-events:none;opacity:0.6;">
  <span style="font-size:13px;color:var(--muted);margin-left:auto;">è‡ªå‹•æ›´æ–° / è‡ªåŠ¨æ›´æ–° / Auto refresh: 5s</span>
</div>  <button onclick="loadData()">è¡¨ç¤º</button>
  <span style="font-size:13px;color:var(--muted);margin-left:auto;">è‡ªå‹•æ›´æ–° / è‡ªåŠ¨æ›´æ–° / Auto refresh: 5s</span>
</div>

<div class="cards">
  <div class="card">
    <div class="label">ç¾åœ¨çŠ¶æ…‹ / å½“å‰çŠ¶æ€ / Current State</div>
    <div class="value mono" id="currentState">--</div>
    <div class="sub" id="lastUpdate">--</div>
  </div>
  <div class="card">
    <div class="label">é›»æ³¢å¼·åº¦ / ä¿¡å·å¼ºåº¦ / Signal</div>
    <div class="value mono" id="lqiValue">--</div>
    <span class="badge" id="lqiBadge">--</span>
  </div>
  <div class="card">
    <div class="label">ãƒãƒƒãƒ†ãƒªãƒ¼ / ç”µé‡ / Battery</div>
    <div class="value mono" id="powerValue">--</div>
    <span class="badge" id="powerBadge">--</span>
  </div>
  <div class="card">
    <div class="label">æœ¬æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ / ä»Šæ—¥äº‹ä»¶æ•° / Today Events</div>
    <div class="value mono" id="totalEvents">--</div>
    <div class="sub" id="accessEvents">--</div>
  </div>
</div>

<div class="count-row">
  <div class="count-card">
    <div class="count-icon">ğŸ”´</div>
    <div>
      <div class="cnt-label">OPEN å›æ•° / æ¬¡æ•° / Count</div>
      <div class="cnt-value cnt-open" id="openCount">--</div>
      <div class="cnt-note">heartbeaté™¤å¤– / ä¸å«å¿ƒè·³åŒ… / Excl. heartbeat</div>
    </div>
  </div>
  <div class="count-card">
    <div class="count-icon">ğŸŸ¢</div>
    <div>
      <div class="cnt-label">CLOSE å›æ•° / æ¬¡æ•° / Count</div>
      <div class="cnt-value cnt-close" id="closeCount">--</div>
      <div class="cnt-note">heartbeaté™¤å¤– / ä¸å«å¿ƒè·³åŒ… / Excl. heartbeat</div>
    </div>
  </div>
</div>

<div class="history">
  <div class="history-header">
    å±¥æ­´ / å†å²è®°å½• / History
    <span id="historyNote">ç›´è¿‘10ä»¶</span>
  </div>
  <div id="tableContainer"><div class="loading">Loading...</div></div>
</div>

<script>
const API_URL = "https://yourapi.execute-api.ap-northeast-1.amazonaws.com/prod/events?device_id=device01";

// Set today's date as default (JST)
const nowJST = new Date(Date.now() + 9 * 3600 * 1000);
document.getElementById("datePicker").value = nowJST.toISOString().slice(0, 10);

// Clock (JST)
setInterval(() => {
  const jst = new Date(Date.now() + 9 * 3600 * 1000);
  document.getElementById("now").innerText =
    jst.toISOString().replace("T", " ").slice(0, 19) + " JST";
}, 1000);

// Theme toggle
function toggleTheme() {
  const isLight = document.body.classList.toggle("light");
  document.getElementById("themeBtn").innerText = isLight ? "ğŸŒ™ ãƒ€ãƒ¼ã‚¯" : "â˜€ï¸ ãƒ©ã‚¤ãƒˆ";
}

function lqiLevel(v) { return v >= 120 ? "strong" : v >= 80 ? "medium" : "weak"; }
function lqiLabel(v) { return v >= 120 ? "â— å¼· Strong" : v >= 80 ? "â— ä¸­ Medium" : "â— å¼± Weak"; }
function lqiLevelLabel(v) { return v >= 120 ? "å¼·" : v >= 80 ? "ä¸­" : "å¼±"; }
function lqiColor(v) { return v >= 120 ? "var(--green)" : v >= 80 ? "var(--yellow)" : "var(--red)"; }
function lqiWidth(v) { return Math.min(100, Math.round(v / 255 * 100)) + "%"; }
function powerLevel(v) { return v >= 30000 ? "good" : "low"; }
function powerLabel(v) { return v >= 30000 ? "â— è‰¯å¥½ Good" : "â— ä½ä¸‹ Low"; }

function getPayload(item) {
  return typeof item.payload === "string" ? JSON.parse(item.payload) : item.payload;
}

function toJST(ts) {
  const d = /^\d+$/.test(String(ts)) ? new Date(parseInt(ts)) : new Date(ts);
  return new Date(d.getTime() + 9 * 3600 * 1000);
}

function formatTime(item) {
  const payload = getPayload(item);
  const ts = payload.timestamp || item.timestamp;
  if (!ts) return "--";
  return toJST(ts).toISOString().replace("T", " ").slice(0, 19) + " JST";
}

function renderTable(history) {
  if (!history || history.length === 0)
    return '<div class="loading">No data</div>';

  const rows = history.map(item => {
    const p = getPayload(item);
    const state     = p.door_state || p.state || "--";
    const eventType = p.event_type || "--";
    const lqi       = p.lqi;
    const power     = p.power;
    const time      = formatTime(item);
    const isAccess  = eventType !== "heartbeat";
    const lqiHtml   = typeof lqi === "number"
      ? `<div class="lqi-bar">${lqi}
           <div class="bar"><div class="fill ${lqiLevel(lqi)}" style="width:${lqiWidth(lqi)}"></div></div>
           <span style="color:${lqiColor(lqi)};font-size:11px">${lqiLevelLabel(lqi)}</span>
         </div>`
      : "--";

    return `<tr>
      <td class="mono">${time}</td>
      <td><span class="state-pill ${state}">${state.toUpperCase()}</span></td>
      <td><span class="event-pill ${isAccess ? 'access' : ''}">${eventType}</span></td>
      <td>${lqiHtml}</td>
      <td class="mono">${power ?? "--"}</td>
    </tr>`;
  }).join("");

  return `<table>
    <thead><tr>
      <th>æ™‚åˆ» / æ—¶é—´ / Time</th><th>çŠ¶æ…‹ / çŠ¶æ€ / State</th><th>ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥</th><th>é›»æ³¢ LQI</th><th>ãƒãƒƒãƒ†ãƒªãƒ¼</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

async function loadData() {
  try {
    const response = await fetch(API_URL);
    const outer = await response.json();
    const data = typeof outer.body === "string" ? JSON.parse(outer.body) : outer;

    const selectedDate = document.getElementById("datePicker").value;
    const history = data.history || [];

    // Current state
    const state = data.current_state || "--";
    const stateEl = document.getElementById("currentState");
    stateEl.innerText = state.toUpperCase();
    stateEl.style.color = state === "open" ? "var(--red)" : "var(--green)";
    document.getElementById("lastUpdate").innerText =
      "æœ€çµ‚æ›´æ–° " + (data.last_update ? toJST(data.last_update).toISOString().slice(11, 19) + " JST" : "--");

    // LQI
    const lqi = data.lqi;
    document.getElementById("lqiValue").innerText = lqi ?? "--";
    if (typeof lqi === "number") {
      const badge = document.getElementById("lqiBadge");
      badge.className = "badge " + lqiLevel(lqi);
      badge.innerText = lqiLabel(lqi);
    }

    // Power
    const power = data.power;
    document.getElementById("powerValue").innerText = power ?? "--";
    if (typeof power === "number") {
      const badge = document.getElementById("powerBadge");
      badge.className = "badge " + powerLevel(power);
      badge.innerText = powerLabel(power);
    }

    // Filter by selected date (JST)
    const filtered = history.filter(item => {
      const p = getPayload(item);
      const ts = p.timestamp || item.timestamp;
      if (!ts) return false;
      const jstDate = toJST(ts).toISOString().slice(0, 10);
      return jstDate === selectedDate;
    });

    document.getElementById("totalEvents").innerText = filtered.length;

    const accessOnly = filtered.filter(item => getPayload(item).event_type !== "heartbeat");
    document.getElementById("accessEvents").innerText = `ã†ã¡é–‹é–‰ ${accessOnly.length}ä»¶`;

    const openCount  = accessOnly.filter(item => {
      const p = getPayload(item);
      return (p.door_state || p.state) === "open";
    }).length;
    const closeCount = accessOnly.filter(item => {
      const p = getPayload(item);
      return (p.door_state || p.state) === "close";
    }).length;

    document.getElementById("openCount").innerText  = openCount;
    document.getElementById("closeCount").innerText = closeCount;

    // Table: show latest 10 from all history
    document.getElementById("tableContainer").innerHTML = renderTable(history.slice(0, 10));
    document.getElementById("historyNote").innerText =
      `ç›´è¿‘10ä»¶ï¼ˆheartbeatå«ã‚€ï¼‰`;

  } catch (err) {
    console.error(err);
    document.getElementById("tableContainer").innerHTML =
      `<div class="loading error-msg">Error: ${err.message}</div>`;
  }
}

loadData();
setInterval(loadData, 5000);
</script>
</body>
</html>
